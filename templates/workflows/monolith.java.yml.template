# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# monolith.yml â€” Generated by monolithx (simple mode)
#
# Single-job, single-file CI/CD workflow for Java (Spring Boot).
# Runs in one job so Docker images built here are available to deploy steps
# on the same runner â€” no registry, no job isolation problems.
#
# To change the working directory (e.g. for a monorepo sub-folder):
#   1. Edit the WORK_DIR env var below, OR
#   2. Set the repository variable WORK_DIR in GitHub Settings â†’ Variables
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: Monolith CI/CD

on:
  push:
    branches:
      - "{{PROD_BRANCH}}"
      - "{{STAGING_BRANCH}}"
  pull_request:

concurrency:
  group: monolith-${{ github.ref }}
  cancel-in-progress: true

env:
  # Working directory â€” change this if your project lives in a sub-folder
  WORK_DIR: ${{ vars.WORK_DIR || '.' }}
  IMAGE_NAME: {{IMAGE_NAME}}
  PORT: {{PORT}}

jobs:
  # â”€â”€ Single job: CI â†’ Build â†’ Simulate Deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci-build-deploy:
    name: "CI â†’ Build â†’ Deploy ({{APP_NAME}})"
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ 2. Set up Java â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Java {{RUNTIME_VERSION}}
        uses: actions/setup-java@v4
        with:
          java-version: "{{RUNTIME_VERSION}}"
          distribution: "temurin"
          cache: "maven"

      # â”€â”€ 3. Install / resolve dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Resolve dependencies
        working-directory: ${{ env.WORK_DIR }}
        run: {{INSTALL_COMMAND}}

      # â”€â”€ 4. Lint / static analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Lint / static analysis
        working-directory: ${{ env.WORK_DIR }}
        run: {{LINT_COMMAND}}

      # â”€â”€ 5. Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run tests
        working-directory: ${{ env.WORK_DIR }}
        run: {{TEST_COMMAND}}

      # â”€â”€ 6. Build application JAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Tests already ran above so -DskipTests is safe here.
      - name: Build application JAR
        working-directory: ${{ env.WORK_DIR }}
        run: {{BUILD_COMMAND}}

      # â”€â”€ 7. Docker build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Docker image
        working-directory: ${{ env.WORK_DIR }}
        run: |
          docker build \
            -t ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.IMAGE_NAME }}:latest \
            .

      # â”€â”€ 8. Verify image exists â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify Docker image was built
        run: |
          docker image inspect ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --format "Image ID: {{.Id}} | Created: {{.Created}}"

      # â”€â”€ 9. Simulate deployment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Simulate deployment (smoke test)
        run: |
          echo "ðŸš€ Starting container ${{ env.IMAGE_NAME }}:${{ github.sha }} on port ${{ env.PORT }}..."
          docker run -d \
            --name {{APP_NAME}}-smoke \
            -p ${{ env.PORT }}:${{ env.PORT }} \
            ${{ env.IMAGE_NAME }}:${{ github.sha }}

          # Spring Boot needs more start-up time
          echo "â³ Waiting for app to become ready..."
          for i in $(seq 1 18); do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" --max-time 3 \
              http://localhost:${{ env.PORT }}{{HEALTH_PATH}} || echo "000")
            if [ "${STATUS}" -ge 200 ] && [ "${STATUS}" -lt 400 ]; then
              echo "âœ… App responded HTTP ${STATUS} on attempt ${i}/18"
              break
            fi
            echo "  attempt ${i}/18 â€” HTTP ${STATUS}, retrying..."
            sleep 5
          done

          FINAL=$(curl -o /dev/null -s -w "%{http_code}" --max-time 5 \
            http://localhost:${{ env.PORT }}{{HEALTH_PATH}} || echo "000")
          if [ "${FINAL}" -lt 200 ] || [ "${FINAL}" -ge 400 ]; then
            echo "âŒ Smoke test FAILED (HTTP ${FINAL}). Container logs:"
            docker logs {{APP_NAME}}-smoke
            docker stop {{APP_NAME}}-smoke || true
            docker rm   {{APP_NAME}}-smoke || true
            exit 1
          fi

          echo "âœ… Deployment simulation PASSED (HTTP ${FINAL})"

      # â”€â”€ 10. Rollback-ready tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Tag image as rollback candidate
        run: |
          docker tag \
            ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            ${{ env.IMAGE_NAME }}:previous
          echo "ðŸ”– Tagged ${{ env.IMAGE_NAME }}:${{ github.sha }} â†’ previous"

      # â”€â”€ 11. Cleanup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Stop smoke-test container
        if: always()
        run: |
          docker stop {{APP_NAME}}-smoke 2>/dev/null || true
          docker rm   {{APP_NAME}}-smoke 2>/dev/null || true
